class m{constructor(){this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){const r=this.listeners[e];r&&(this.listeners[e]=r.filter(n=>n!==t))}emit(e,t){const r=this.listeners[e];r&&r.forEach(n=>{try{n(t)}catch(s){console.error(`Error in event listener for ${String(e)}:`,s)}})}}function P(i,e=1e3,t=3e4){const r=e*Math.pow(2,i),n=Math.min(r,t),s=Math.random()*100;return Math.min(n+s,t+100)}class U{constructor(e,t,r={}){this.events=new m,this._isSyncing=!1,this.queue=e,this.network=t,this.config=r,this.network.onNetworkChange(n=>{n&&this.startSync()})}get isSyncing(){return this._isSyncing}async startSync(){if(!this._isSyncing&&this.network.isOnline()){this._isSyncing=!0,this.events.emit("sync:start",void 0);try{for(;this.network.isOnline();){const e=await this.queue.peekNextRequest();if(!e){this.events.emit("queue-empty",void 0);break}const{item:t,key:r}=e;try{await this.processRequest(t),await this.queue.dequeueRequest(r),this.events.emit("request-success",{id:t.id,response:"OK"})}catch(n){if(n.status===401&&this.config.refreshToken){console.log("Token expired, refreshing...");try{await this.config.refreshToken();continue}catch(s){console.error("Refresh token failed, marking request as permanent error:",t.id,s),await this.queue.dequeueRequest(r),this.events.emit("request-error",{id:t.id,error:s,permanent:!0});continue}}if(this.isPermanentError(n))console.error("Permanent error, discarding request:",t.id,n),await this.queue.dequeueRequest(r),this.events.emit("request-error",{id:t.id,error:n,permanent:!0});else{t.retryCount=(t.retryCount||0)+1;const s=this.config.maxRetries||5;if(t.retryCount>s)console.error(`Max retries (${s}) exceeded for request:`,t.id,n),await this.queue.dequeueRequest(r),this.events.emit("request-error",{id:t.id,error:n,permanent:!0});else{await this.queue.updateRequest(r,t);const o=P(t.retryCount,this.config.backoffFactor||1e3);console.warn(`Transient error. Retrying in ${o}ms...`,n),await new Promise(u=>setTimeout(u,o))}}}}}finally{this._isSyncing=!1,this.events.emit("sync:end",void 0)}}}async processRequest(e){const t=await fetch(e.url,{method:e.method,headers:e.headers,body:e.body});if(!t.ok)throw{status:t.status,statusText:t.statusText};return t}isPermanentError(e){return e&&typeof e.status=="number"?e.status>=400&&e.status<500&&e.status!==401&&e.status!==429:!1}}const D="modulepreload",R=function(i){return"/rest-sync-lite/"+i},p={},z=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let h=function(d){return Promise.all(d.map(l=>Promise.resolve(l).then(w=>({status:"fulfilled",value:w}),w=>({status:"rejected",reason:w}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),u=o?.nonce||o?.getAttribute("nonce");n=h(t.map(d=>{if(d=R(d),d in p)return;p[d]=!0;const l=d.endsWith(".css"),w=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${d}"]${w}`))return;const f=document.createElement("link");if(f.rel=l?"stylesheet":D,l||(f.as="script"),f.crossOrigin="",f.href=d,u&&f.setAttribute("nonce",u),document.head.appendChild(f),l)return new Promise((k,E)=>{f.addEventListener("load",k),f.addEventListener("error",()=>E(new Error(`Unable to preload CSS for ${d}`)))})}))}function s(o){const u=new Event("vite:preloadError",{cancelable:!0});if(u.payload=o,window.dispatchEvent(u),!u.defaultPrevented)throw o}return n.then(o=>{for(const u of o||[])u.status==="rejected"&&s(u.reason);return e().catch(s)})};let a=null,c="";function x(i,e){return new Promise((t,r)=>{if(typeof indexedDB>"u")return r(new Error("indexedDB is not defined"));if(a&&a.name===i&&a.objectStoreNames.contains(e))return t();const n=indexedDB.open(i,2);n.onupgradeneeded=s=>{const o=s.target.result;let u;o.objectStoreNames.contains(e)?u=s.target.transaction.objectStore(e):u=o.createObjectStore(e,{autoIncrement:!0}),u.indexNames.contains("priority_idx")||u.createIndex("priority_idx","priority",{unique:!1})},n.onsuccess=s=>{a=s.target.result,c=e,t()},n.onerror=s=>{r(s.target.error)}})}function q(){a&&(a.close(),a=null)}function g(i){return new Promise((e,t)=>{if(!a)return t(new Error("Database not initialized"));const s=a.transaction(c,"readwrite").objectStore(c).add(i);s.onsuccess=()=>e(s.result),s.onerror=()=>t(s.error)})}function v(){return new Promise((i,e)=>{if(!a)return e(new Error("Database not initialized"));const n=a.transaction(c,"readonly").objectStore(c).openCursor();n.onsuccess=s=>{const o=s.target.result;i(o?{id:o.key,value:o.value}:void 0)},n.onerror=()=>e(n.error)})}function S(i){return new Promise((e,t)=>{if(!a)return t(new Error("Database not initialized"));const s=a.transaction(c,"readwrite").objectStore(c).delete(i);s.onsuccess=()=>e(),s.onerror=()=>t(s.error)})}function b(){return new Promise((i,e)=>{if(!a)return e(new Error("Database not initialized"));const n=a.transaction(c,"readonly").objectStore(c).count();n.onsuccess=()=>i(n.result),n.onerror=()=>e(n.error)})}function _(i,e){return new Promise((t,r)=>{if(!a)return r(new Error("Database not initialized"));const o=a.transaction(c,"readwrite").objectStore(c).put(e,i);o.onsuccess=()=>t(),o.onerror=()=>r(o.error)})}function y(i){return new Promise((e,t)=>{if(!a)return t(new Error("Database not initialized"));const n=a.transaction(c,"readonly").objectStore(c);if(!n.indexNames.contains("priority_idx"))return e(void 0);const o=n.index("priority_idx").openCursor(IDBKeyRange.only(i));o.onsuccess=u=>{const h=u.target.result;e(h?{id:h.primaryKey,value:h.value}:void 0)},o.onerror=()=>t(o.error)})}function B(i,e){return new Promise((t,r)=>{if(!a)return r(new Error("Database not initialized"));const o=a.transaction(c,"readwrite").objectStore(c).openCursor();let u=!1;o.onsuccess=h=>{const d=h.target.result;if(d)if(d.value&&d.value[i]===e){const l=d.delete();l.onsuccess=()=>{u=!0,t(!0)},l.onerror=()=>r(l.error)}else d.continue();else t(u)},o.onerror=()=>r(o.error)})}function O(){return new Promise((i,e)=>{if(!a)return i();const n=a.transaction(c,"readwrite").objectStore(c).clear();n.onsuccess=()=>i(),n.onerror=()=>e(n.error)})}function C(i){return q(),new Promise((e,t)=>{if(typeof indexedDB>"u")return e();const r=indexedDB.deleteDatabase(i);r.onerror=()=>t(r.error),r.onsuccess=()=>e()})}const I=Object.freeze(Object.defineProperty({__proto__:null,addItem:g,clearStore:O,closeDB:q,count:b,deleteDB:C,initDB:x,peekFirstByPriority:y,peekItem:v,removeByField:B,removeItem:S,updateItem:_},Symbol.toStringTag,{value:"Module"}));function M(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,i=>{const e=Math.random()*16|0;return(i==="x"?e:e&3|8).toString(16)})}const T="rest-sync-lite",L="request-queue";class j{constructor(){this.initialized=null,this._queueSize=0,this.events=new m}async init(){return this.initialized||(this.initialized=x(T,L).then(async()=>{this._queueSize=await b(),this.events.emit("queue:update",void 0)})),this.initialized}get size(){return this._queueSize}async enqueueRequest(e){await this.init();const t=e.id||M(),r={...e,id:t,timestamp:Date.now(),retryCount:0};return await g(r),this._queueSize++,this.events.emit("queue:update",void 0),t}async peekNextRequest(){await this.init();let e=await y("high");if(e)return{item:e.value,key:e.id};if(e=await y("normal"),e)return{item:e.value,key:e.id};if(e=await y("low"),e)return{item:e.value,key:e.id};const t=await v();if(t)return{item:t.value,key:t.id}}async dequeueRequest(e){await this.init(),await S(e),this._queueSize=Math.max(0,this._queueSize-1),this.events.emit("queue:update",void 0)}async updateRequest(e,t){await this.init(),await _(e,t)}async cancelRequest(e){return await this.init(),await z(()=>Promise.resolve().then(()=>I),void 0).then(t=>t.removeByField("id",e))}}class N{constructor(){this.events=new m,this._isOnline=!0,typeof window<"u"?(this._isOnline=navigator.onLine,window.addEventListener("online",()=>this.updateState(!0)),window.addEventListener("offline",()=>this.updateState(!1))):typeof self<"u"&&typeof navigator<"u"&&(this._isOnline=navigator.onLine)}isOnline(){if(typeof window<"u"){if(window._forceOffline)return!1;if(window._forceOnline)return!0}return typeof navigator<"u"?navigator.onLine:!0}onNetworkChange(e){this.events.on("network-change",e)}updateState(e){this._isOnline!==e&&(this._isOnline=e,this.events.emit("network-change",e))}}export{m as E,N,j as Q,U as S};
