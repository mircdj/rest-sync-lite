class y{constructor(){this.listeners={}}on(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}off(e,t){const r=this.listeners[e];r&&(this.listeners[e]=r.filter(n=>n!==t))}emit(e,t){const r=this.listeners[e];r&&r.forEach(n=>{try{n(t)}catch(i){console.error(`Error in event listener for ${String(e)}:`,i)}})}}function R(s,e=1e3,t=3e4){const r=e*Math.pow(2,s),n=Math.min(r,t),i=Math.random()*100;return Math.min(n+i,t+100)}class U{constructor(e,t,r={}){this.events=new y,this._isSyncing=!1,this.queue=e,this.network=t,this.config=r,this.network.onNetworkChange(n=>{n&&this.startSync()})}get isSyncing(){return this._isSyncing}async startSync(){if(!this._isSyncing&&this.network.isOnline()){this._isSyncing=!0,this.events.emit("sync:start",void 0);try{for(;this.network.isOnline();){const e=await this.queue.peekNextRequest();if(!e){this.events.emit("queue-empty",void 0);break}const{item:t,key:r}=e;try{await this.processRequest(t),await this.queue.dequeueRequest(r),this.events.emit("request-success",{id:t.id,response:"OK"})}catch(n){if(n.status===401&&this.config.refreshToken){console.log("Token expired, refreshing...");try{await this.config.refreshToken();continue}catch(i){console.error("Refresh token failed, marking request as permanent error:",t.id,i),await this.queue.dequeueRequest(r),this.events.emit("request-error",{id:t.id,error:i,permanent:!0});continue}}if(this.isPermanentError(n))console.error("Permanent error, discarding request:",t.id,n),await this.queue.dequeueRequest(r),this.events.emit("request-error",{id:t.id,error:n,permanent:!0});else{t.retryCount=(t.retryCount||0)+1;const i=this.config.maxRetries||5;if(t.retryCount>i)console.error(`Max retries (${i}) exceeded for request:`,t.id,n),await this.queue.dequeueRequest(r),this.events.emit("request-error",{id:t.id,error:n,permanent:!0});else{await this.queue.updateRequest(r,t);const o=R(t.retryCount,this.config.backoffFactor||1e3);console.warn(`Transient error. Retrying in ${o}ms...`,n),await new Promise(a=>setTimeout(a,o))}}}}}finally{this._isSyncing=!1,this.events.emit("sync:end",void 0)}}}async processRequest(e){const t=await fetch(e.url,{method:e.method,headers:e.headers,body:e.body});if(!t.ok)throw{status:t.status,statusText:t.statusText};return t}isPermanentError(e){return e&&typeof e.status=="number"?e.status>=400&&e.status<500&&e.status!==401&&e.status!==429:!1}}const z="modulepreload",I=function(s){return"/rest-sync-lite/"+s},p={},q=function(e,t,r){let n=Promise.resolve();if(t&&t.length>0){let h=function(l){return Promise.all(l.map(d=>Promise.resolve(d).then(m=>({status:"fulfilled",value:m}),m=>({status:"rejected",reason:m}))))};document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=o?.nonce||o?.getAttribute("nonce");n=h(t.map(l=>{if(l=I(l),l in p)return;p[l]=!0;const d=l.endsWith(".css"),m=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${m}`))return;const f=document.createElement("link");if(f.rel=d?"stylesheet":z,d||(f.as="script"),f.crossOrigin="",f.href=l,a&&f.setAttribute("nonce",a),document.head.appendChild(f),d)return new Promise((D,P)=>{f.addEventListener("load",D),f.addEventListener("error",()=>P(new Error(`Unable to preload CSS for ${l}`)))})}))}function i(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return n.then(o=>{for(const a of o||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})};let u=null,c="";function g(s,e){return new Promise((t,r)=>{if(typeof indexedDB>"u")return r(new Error("indexedDB is not defined"));if(u&&u.name===s&&u.objectStoreNames.contains(e))return t();const n=indexedDB.open(s,2);n.onupgradeneeded=i=>{const o=i.target.result;let a;o.objectStoreNames.contains(e)?a=i.target.transaction.objectStore(e):a=o.createObjectStore(e,{autoIncrement:!0}),a.indexNames.contains("priority_idx")||a.createIndex("priority_idx","priority",{unique:!1})},n.onsuccess=i=>{u=i.target.result,c=e,t()},n.onerror=i=>{r(i.target.error)}})}function v(){u&&(u.close(),u=null)}function S(s){return new Promise((e,t)=>{if(!u)return t(new Error("Database not initialized"));const i=u.transaction(c,"readwrite").objectStore(c).add(s);i.onsuccess=()=>e(i.result),i.onerror=()=>t(i.error)})}function _(){return new Promise((s,e)=>{if(!u)return e(new Error("Database not initialized"));const n=u.transaction(c,"readonly").objectStore(c).openCursor();n.onsuccess=i=>{const o=i.target.result;s(o?{id:o.key,value:o.value}:void 0)},n.onerror=()=>e(n.error)})}function b(s){return new Promise((e,t)=>{if(!u)return t(new Error("Database not initialized"));const i=u.transaction(c,"readwrite").objectStore(c).delete(s);i.onsuccess=()=>e(),i.onerror=()=>t(i.error)})}function E(){return new Promise((s,e)=>{if(!u)return e(new Error("Database not initialized"));const n=u.transaction(c,"readonly").objectStore(c).count();n.onsuccess=()=>s(n.result),n.onerror=()=>e(n.error)})}function k(s,e){return new Promise((t,r)=>{if(!u)return r(new Error("Database not initialized"));const o=u.transaction(c,"readwrite").objectStore(c).put(e,s);o.onsuccess=()=>t(),o.onerror=()=>r(o.error)})}function w(s){return new Promise((e,t)=>{if(!u)return t(new Error("Database not initialized"));const n=u.transaction(c,"readonly").objectStore(c);if(!n.indexNames.contains("priority_idx"))return e(void 0);const o=n.index("priority_idx").openCursor(IDBKeyRange.only(s));o.onsuccess=a=>{const h=a.target.result;e(h?{id:h.primaryKey,value:h.value}:void 0)},o.onerror=()=>t(o.error)})}function B(s,e){return new Promise((t,r)=>{if(!u)return r(new Error("Database not initialized"));const o=u.transaction(c,"readwrite").objectStore(c).openCursor();let a=!1;o.onsuccess=h=>{const l=h.target.result;if(l)if(l.value&&l.value[s]===e){const d=l.delete();d.onsuccess=()=>{a=!0,t(!0)},d.onerror=()=>r(d.error)}else l.continue();else t(a)},o.onerror=()=>r(o.error)})}function O(){return new Promise((s,e)=>{if(!u)return s();const n=u.transaction(c,"readwrite").objectStore(c).clear();n.onsuccess=()=>s(),n.onerror=()=>e(n.error)})}function C(s){return v(),new Promise((e,t)=>{if(typeof indexedDB>"u")return e();const r=indexedDB.deleteDatabase(s);r.onerror=()=>t(r.error),r.onsuccess=()=>e()})}function A(){return new Promise((s,e)=>{if(!u)return e(new Error("Database not initialized"));const n=u.transaction(c,"readonly").objectStore(c).openCursor(),i=[];n.onsuccess=o=>{const a=o.target.result;a?(i.push({id:a.key,value:a.value}),a.continue()):s(i)},n.onerror=()=>e(n.error)})}const x=Object.freeze(Object.defineProperty({__proto__:null,addItem:S,clearStore:O,closeDB:v,count:E,deleteDB:C,getAllItems:A,initDB:g,peekFirstByPriority:w,peekItem:_,removeByField:B,removeItem:b,updateItem:k},Symbol.toStringTag,{value:"Module"}));function M(){return typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,s=>{const e=Math.random()*16|0;return(s==="x"?e:e&3|8).toString(16)})}const T="rest-sync-lite",L="request-queue";class j{constructor(){this.initialized=null,this._queueSize=0,this.events=new y}async init(){return this.initialized||(this.initialized=g(T,L).then(async()=>{this._queueSize=await E(),this.events.emit("queue:update",void 0)})),this.initialized}get size(){return this._queueSize}async enqueueRequest(e){await this.init();const t=e.id||M(),r={...e,id:t,timestamp:Date.now(),retryCount:0};return await S(r),this._queueSize++,this.events.emit("queue:update",void 0),t}async peekNextRequest(){await this.init();let e=await w("high");if(e)return{item:e.value,key:e.id};if(e=await w("normal"),e)return{item:e.value,key:e.id};if(e=await w("low"),e)return{item:e.value,key:e.id};const t=await _();if(t)return{item:t.value,key:t.id}}async dequeueRequest(e){await this.init(),await b(e),this._queueSize=Math.max(0,this._queueSize-1),this.events.emit("queue:update",void 0)}async updateRequest(e,t){await this.init(),await k(e,t)}async cancelRequest(e){await this.init();const t=await q(()=>Promise.resolve().then(()=>x),void 0).then(r=>r.removeByField("id",e));return t&&(this._queueSize=Math.max(0,this._queueSize-1),this.events.emit("queue:update",void 0)),t}async getAllItems(){await this.init();const{getAllItems:e}=await q(async()=>{const{getAllItems:r}=await Promise.resolve().then(()=>x);return{getAllItems:r}},void 0);return(await e()).map(r=>r.value)}}class N{constructor(){this.events=new y,this._isOnline=!0,typeof window<"u"?(this._isOnline=navigator.onLine,window.addEventListener("online",()=>this.updateState(!0)),window.addEventListener("offline",()=>this.updateState(!1))):typeof self<"u"&&typeof navigator<"u"&&(this._isOnline=navigator.onLine)}isOnline(){if(typeof window<"u"){if(window._forceOffline)return!1;if(window._forceOnline)return!0}return typeof navigator<"u"?navigator.onLine:!0}onNetworkChange(e){this.events.on("network-change",e)}updateState(e){this._isOnline!==e&&(this._isOnline=e,this.events.emit("network-change",e))}}export{y as E,N,j as Q,U as S};
